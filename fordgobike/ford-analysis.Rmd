---
title: "Exploring San Francisco Bay Area's Bike Share System"
author: "Tony Lin"
date: "August 29, 2018"
output: html_document
---

Congested streets and slow-crawling traffic are a fact of life in many metropolitan areas, such as New York City, Los Angeles, and Chicago. Bike sharing is an innovative solution for such problems, and it works by dispersing a large fleet of publicly-available bikes throughout crowded cities for personal transport. Implemented in 2013, Ford GoBike is the first bike sharing system introduced in the US West Coast. Its 540 stations and 7,000 bikes sprawl across five cities in the San Francisco/Bay Area. As an avid GoBike user and a data fanatic, I am excited to explore, using R, the trip data that has been collected in 2018.

```{r echo=FALSE}
setwd("C:/Users/Tony Lin/Desktop/DataScience-tutorial/fordgobike/")
```


## Data Acquisition

First, I downloaded the [system data](https://www.fordgobike.com/system-data) from the Ford GoBike website and saved it in my working directory. Currently, eight data files are available online, a collective one for 2017 and one for each month of 2018 up to July. In this analysis, I will solely focus on data that has been generated in 2018.

```{r}
# List of data files
file_names = list.files(pattern = ".csv")
file_names
```

To read the files into R, I iterate through `file_names` using the `lapply` function:

```{r}
# Read data (this will take a second)
df_list = lapply(file_names,
                 function(x) read.csv(x, stringsAsFactors = FALSE))

# Assign name to data frames
names(df_list) = file_names
```


## Data Organization and Cleaning

### Aggregate Data into a Single Data Frame

Let's look at the headers of the first three data frames in `df_list`:

```{r}
# Extract column names from the first 3 data frames
head(lapply(df_list, names), 3)
```

Information on ride duration, starting and ending time/location, and usership are provided. Notice that the data contains a column called `"bike_share_for_all_trip"`, which tracks members who are enrolled in the Bike Share for All program for low-income residents.

We will collapse the data frames into one and examine the data structure:

```{r warning=FALSE, message=FALSE}
# Cast certain columns as numeric to enable row binding
df_list[[6]]$start_station_id = as.numeric(df_list[[6]]$start_station_id)
df_list[[6]]$end_station_id = as.numeric(df_list[[6]]$end_station_id)
df_list[[7]]$start_station_id = as.numeric(df_list[[7]]$start_station_id)
df_list[[7]]$end_station_id = as.numeric(df_list[[7]]$end_station_id)

# Bind data frames by rows
library(dplyr)
df = bind_rows(df_list)

# Glimpse at df
glimpse(df)
```

### Format Data Types

Data cleaning is essential for downstream analysis. This entails formating the columns into appropriate data types and extracting essential data. For instance, I will isolate the month and hour from `start_time` for visualizing bike usage over time. In addition, I will convert `member_birth_year` into `member_age`. Moreover, I will derive ride duration in minutes from `duration_sec`. Finally, the `character` columns should take on type `factor`.

```{r warning=FALSE}
# Extract month from start_time
df = df %>%
  mutate(start_month = sub(" .*", "", start_time)) %>%
  mutate(start_month = as.POSIXct(start_month)) %>%
  mutate(start_month = format(start_month, "%B"))

# Extract hour from start_time
library(stringr)
df = df %>%
  mutate(start_hour = sub("^.{11}", "", start_time)) %>%
  mutate(start_hour = str_extract(start_hour, "^[0-9]{2}"))

# Convert birth year to age
df = df %>%
  mutate(member_age = 2018 - member_birth_year)

# Convert duration_sec to duration_min
df = df %>%
  mutate(duration_min = duration_sec / 60)

# Convert characters to factors
character_vars = which(sapply(df, is.character))
df[character_vars] = lapply(df[character_vars], as.factor)

# Remove columns not used in the analysis
df = select(df, -c(start_time, end_time, start_station_id, end_station_id, bike_id, member_birth_year, duration_sec))

# Glimpse at cleaned df
glimpse(df)
```

The cleaned data frame contains 12 descriptors for over a million rides.


## Data Analysis

### Bike Usage by Month in 2018

Let's examine the GoBike usage over time in 2018:

```{r}
# Organize month
df$start_month = factor(df$start_month, 
                        levels = c("January", "February", "March", "April", "May", "June", "July"))

# Count usage by month
month_counts = table(df$start_month)

# Plot barplot
bar = barplot(month_counts,
              ylim = c(0, 220000),
              xlab = "Months in 2018",
              ylab = "Number of Rides",
              main = "GoBike Usage by Month")
text(x = bar, y = month_counts,   # Add labels
     label = month_counts, pos = 3, cex = 0.8, col = "red")  
```

The plot shows a consistent growth in the number of rides over the months. Six months into 2018, the bike usage more than doubled. In addition, there's a large increase in the number of rides from April to May, which may be associated with warmer weather in the summer months along with growing adoption of the bike share service.

### Bike Usage by Customers and Subscribers

Next, I will stratify the barplot by `user_type` to reveal information on the GoBike users.

```{r}
# Plot barplot
library(ggplot2)
ggplot(df, aes(start_month)) + 
  geom_bar() +
  facet_grid(. ~ user_type) +
  xlab("Months in 2018") + 
  ylab("Number of Rides") +
  ggtitle("Comparison of Usage Between Customers and Subscribers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))   # Rotate x-axis labels
```

It is evident that the majority of the rides are made by subscribers of the monthly or yearly plan while only a fraction (~`r round(sum(df$user_type == "Customer") / nrow(df) * 100)`%) come from single-use customers. Proportionally, the number of users in both categories spiked from April to May, which reflects our initial finding.

### Bike Usage by Gender

In my experience, the bikes are predominately operated by males. Let's test this intuition and see whether the gender composition of users evolved over time:

```{r}
# Organize data by gender
df_gender = df %>%
  filter(member_gender %in% c("Male", "Female")) %>%   # Isolate "Male" and "Female" genders
  mutate(member_gender = droplevels(member_gender))   # Drop unused levels

# Plot barplot
ggplot(df_gender, aes(start_month, fill = member_gender)) +
  geom_bar(position = "fill") +
  xlab("Months in 2018") + 
  ylab("Proportion of Rides") +
  ggtitle("Bike Usage by Gender over Time") +
  guides(fill = guide_legend(title = "Gender")) +
  theme_minimal()
```

There are roughly three times as many male as female users, and the proportions have not changed over time.

### Distribution of the Age of GoBike Users

We have found that male users outnumber the female users. Now, we will investigate the age of our cohort. It is important to be aware that our metric is "number of rides" not "number of users." That is to say the height of the bins is a function of both the number of users **and** frequency of use by individuals in a given age range. For privacy concerns, user IDs are excluded in the online data.

```{r warning=FALSE}
# Plot histogram
ggplot(df, aes(member_age)) +
  geom_histogram(binwidth = 2, alpha = 0.5) +
  scale_x_continuous(limits = c(10, 100),
                     breaks = seq(10, 100, by = 4)) +
  xlab("Age in Years") + 
  ylab("Number of Rides") +
  ggtitle("Total Rides by Age") +
  theme_minimal()
```

Take note that `r sum(is.na(df$member_age))` data points are omitted from the plot because age was not provided by the user. Furthermore, there is reason to question the validity of the self-reported age since the oldest user is recorded as being `r max(df$member_age, na.rm = TRUE)`. Nonetheless, the distribution indicates that the age of the majority of users ranges from mid-twenties to mid-thirties, with a median of `r median(df$member_age, na.rm = TRUE)` and mean of `r round(mean(df$member_age, na.rm = TRUE), 1)`.

### Bike Usage by Hour

GoBikes are an integral part of my daily commute to work. I suspect that many others use it for the same reason. To explore this hunch, let's track bike usage by the hour:

```{r}
# Organize usage by hour
hour = df %>%
  group_by(start_hour) %>%
  summarise(total = n())

# Plot barplot
ggplot(hour, aes(x = start_hour, y = total, group = 1)) + 
  geom_line() +
  geom_point(color = "red") +
  xlab("Time in Hours") + 
  ylab("Number of Rides") +
  ggtitle("Total Rides by Hour") +
  theme_minimal()

```

A bimodal curve with peaks at 8 AM and 5 PM confirms my gut instinct that the bike share system is busiest during commute hours. Along the same lines, it should not come as a surprise that the quietest times are in the wee hours of the night.

### Distribution of Ride Duration


### Mapping GoBike Stations

Most used stations?

Peak usage?


## Closing Remarks

[Citi Bike](https://www.citibikenyc.com/system-data) is the Ford GoBike for New York City. Its system is more established and its data date back to 2013, which means more data to play with. I encourage you to 

